# Task 1.2: Protected Files Guard

Navigation: [Design](../design.md) | [PRD](../../../stories/1/prd.md)

## Objective

Create `.claude/hooks/protected-files-guard.py` - a Python script that intercepts Edit/Write/MultiEdit tool calls and either blocks modifications to sensitive files or requires confirmation for certain file types.

## Output File

`.claude/hooks/protected-files-guard.py`

## Input Specification

JSON on stdin:
```json
{
  "tool_name": "Edit",
  "tool_input": {
    "file_path": "/path/to/file"
  }
}
```

Note: Some tools use `path` instead of `file_path`. Handle both.

## Output Specification

| Scenario | Exit Code | stdout | stderr |
|----------|-----------|--------|--------|
| Allow | 0 | (empty) | (empty) |
| Ask | 0 | JSON with `permissionDecision: "ask"` | (empty) |
| Block | 2 | (empty) | Block message with pattern + file_path |

## Implementation

### Constants

Define two lists at the top of the script:

#### ALWAYS_BLOCK (Never Modify)
```python
ALWAYS_BLOCK = [
    '.env',
    '.env.local',
    '.env.production',
    '.pem',
    '.key',
    'id_rsa',
    'id_ed25519',
    'secrets.yml',
    'secrets.yaml',
    'credentials.json',
    'service-account.json',
    '.git/config',
    '.ssh/',
]
```

#### REQUIRE_CONFIRMATION
```python
REQUIRE_CONFIRMATION = [
    'package-lock.json',
    'yarn.lock',
    'pnpm-lock.yaml',
    'Dockerfile',
    'docker-compose.yml',
    'docker-compose.yaml',
    '.github/',
    '.gitlab-ci.yml',
    'Makefile',
    'tsconfig.json',
    'pyproject.toml',
    'Cargo.toml',
    '.claude/',
]
```

### Algorithm

```python
def main():
    try:
        data = json.load(sys.stdin)
        tool_input = data.get('tool_input', {})

        # Handle both file_path and path fields
        file_path = tool_input.get('file_path', '') or tool_input.get('path', '')

        # Check ALWAYS_BLOCK first
        for pattern in ALWAYS_BLOCK:
            if pattern in file_path:
                print(f"üõë BLOCKED: Modifications to '{file_path}' are never allowed. "
                      f"Matched pattern: '{pattern}'", file=sys.stderr)
                sys.exit(2)

        # Check REQUIRE_CONFIRMATION
        for pattern in REQUIRE_CONFIRMATION:
            if pattern in file_path:
                output = {
                    "hookSpecificOutput": {
                        "hookEventName": "PreToolUse",
                        "permissionDecision": "ask",
                        "permissionDecisionReason": (
                            f"‚ö†Ô∏è  Modifying '{file_path}' requires confirmation. "
                            f"This file matches sensitive pattern: '{pattern}'"
                        )
                    }
                }
                print(json.dumps(output))
                sys.exit(0)

        # Allow
        sys.exit(0)

    except json.JSONDecodeError as e:
        print(f"Hook error: Invalid JSON input - {e}", file=sys.stderr)
        sys.exit(1)
    except Exception as e:
        print(f"Hook error: {e}", file=sys.stderr)
        sys.exit(1)

if __name__ == "__main__":
    main()
```

### Error Handling

| Exception | Exit Code | Behavior |
|-----------|-----------|----------|
| JSONDecodeError | 1 | Non-blocking, logged in verbose mode |
| Any other exception | 1 | Non-blocking, logged in verbose mode |
| Missing file_path | 0 | Allow (fail-open) |

## Dependencies

- Python 3.6+ (for f-strings)
- Standard library only: `sys`, `json`

## Testing

```bash
# Test block
echo '{"tool_input":{"file_path":".env"}}' | python3 ./protected-files-guard.py
echo "Exit code: $?"  # Should be 2

# Test ask
echo '{"tool_input":{"file_path":"Dockerfile"}}' | python3 ./protected-files-guard.py
echo "Exit code: $?"  # Should be 0, with JSON output

# Test allow
echo '{"tool_input":{"file_path":"src/main.ts"}}' | python3 ./protected-files-guard.py
echo "Exit code: $?"  # Should be 0, no output

# Test alternative path field
echo '{"tool_input":{"path":"package-lock.json"}}' | python3 ./protected-files-guard.py
echo "Exit code: $?"  # Should be 0, with JSON output

# Test invalid JSON
echo 'not json' | python3 ./protected-files-guard.py
echo "Exit code: $?"  # Should be 1
```

## Acceptance Criteria

- [ ] Script is executable (`chmod +x`)
- [ ] Shebang is `#!/usr/bin/env python3`
- [ ] All ALWAYS_BLOCK patterns from design are implemented
- [ ] All REQUIRE_CONFIRMATION patterns from design are implemented
- [ ] Handles both `file_path` and `path` input fields
- [ ] Block message goes to stderr
- [ ] Ask JSON goes to stdout
- [ ] Exit codes match specification
- [ ] Handles invalid JSON gracefully (exit 1)
- [ ] Handles missing file_path gracefully (exit 0)
